// This is your Prisma schema file

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  output          = "../generated/client"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

// ============================================
// USER & SUBSCRIPTION MODELS
// ============================================

model User {
  id      String @id @default(cuid())
  clerkId String @unique
  email   String @unique

  // Stripe Integration
  stripeCustomerId String? @unique

  // Current Subscription Tier (cached from Stripe)
  subscriptionTier SubscriptionTier @default(FREE)

  // Usage Tracking
  apiCallsCount Int      @default(0)
  usageResetAt  DateTime @default(now())

  // Relations
  subscriptions Subscription[]
  usageLogs     UsageLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clerkId])
  @@index([stripeCustomerId])
  @@index([email])
}

model Subscription {
  id String @id @default(cuid())

  // User Relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe Data
  stripeSubscriptionId String @unique
  stripePriceId        String
  stripeProductId      String
  stripeCustomerId     String

  // Subscription Details
  status          SubscriptionStatus
  tier            SubscriptionTier
  billingInterval BillingInterval    @default(MONTHLY)

  // Billing Period
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@index([status])
}

model UsageLog {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  action   String
  count    Int     @default(1)
  endpoint String?
  metadata Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, action])
  @@index([createdAt])
}

// ============================================
// ENUMS
// ============================================

enum SubscriptionTier {
  FREE
  PRO
  BUSINESS
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAST_DUE
  TRIALING
  UNPAID
  PAUSED
}

// ============================================
// EXISTING MODELS
// ============================================

model Page {
  id   Int    @id @default(autoincrement())
  name String
}
